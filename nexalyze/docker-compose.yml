version: '3.8'

services:
  # Neo4j Database for Knowledge Graph
  neo4j:
    image: neo4j:5.13-community
    container_name: nexalyze_neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/password123
      - NEO4J_server_memory_pagecache_size=1G
      - NEO4J_server_memory_heap_max__size=1G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs

  # PostgreSQL for Structured Data
  postgres:
    image: postgres:15
    container_name: nexalyze_postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=nexalyze
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password123
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Redis for Caching
  redis:
    image: redis:7-alpine
    container_name: nexalyze_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # FastAPI Backend
  backend:
    build: ./backend
    container_name: nexalyze_backend
    ports:
      - "8000:8000"
    environment:
      - AWS_PROFILE=${AWS_PROFILE:-amplify}
      - AWS_REGION=${AWS_REGION:-us-west-2}
      - BEDROCK_MODEL_ID=${BEDROCK_MODEL_ID:-us.anthropic.claude-sonnet-4-5-20250929-v1:0}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password123
      - POSTGRES_URL=postgresql://postgres:password123@postgres:5432/nexalyze
      - REDIS_URL=redis://redis:6379
      - SERP_API_KEY=${SERP_API_KEY}
    depends_on:
      - neo4j
      - postgres
      - redis
    volumes:
      - ./backend:/app
      - ~/.aws:/root/.aws:ro
    command: uvicorn main:app --host 0.0.0.0 --port 8000

  # Streamlit Frontend
  frontend:
    build: ./frontend
    container_name: nexalyze_frontend
    ports:
      - "8501:8501"
    environment:
      - BACKEND_URL=http://backend:8000
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
    command: streamlit run app.py --server.address 0.0.0.0 --server.port 8501

volumes:
  neo4j_data:
  neo4j_logs:
  postgres_data:
  redis_data:
